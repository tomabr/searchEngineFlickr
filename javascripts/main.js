var myApp=angular.module("mySearch",[]);angular.module("mySearch").constant("apiKey","f8ce2d65669e201b2b50723818e2b16b"),angular.module("mySearch").controller("ApplicationController",["$scope","$rootScope",function(e,o){o.$on("handleEmit",function(e,t){o.$broadcast("handleBroadcast",{photo:t.photo})})}]),angular.module("mySearch").controller("FavouriteListController",["$scope","$rootScope",function(e,o){angular.extend(e,{favouritePhotos:[]});var t=JSON.parse(localStorage.getItem("favouritePhotos"))||[];e.favouritePhotos=t,e.$on("handleBroadcast",function(o,r){var a=$.inArray(r.photo,t);0>a&&(t.push(r.photo),e.favouritePhotos=t,localStorage.setItem("favouritePhotos",JSON.stringify(t)))}),e.clearFavouritePhotos=function(){e.favouritePhotos=[],t=[],localStorage.removeItem("favouritePhotos")}}]),angular.module("mySearch").controller("SearchController",["$scope","$rootScope","flickrRepoService",function(e,o,t){angular.extend(e,{photos:[],error:void 0});var r=[];e.search=function(){t.clearPhotos(),e.searchTerm&&t.getPhotos({term:e.searchTerm,page:1}).then(function(o){e.error=void 0,e.photos=o},function(o){e.error=o})},e.reset=function(){e.searchTerm=""},e.addToFavourite=function(o){r.push(o),e.$emit("handleEmit",{photo:o})}}]),angular.module("mySearch").directive("scroll",["$window","$document","flickrRepoService",function(e,o,t){return function(r,a,n){angular.element(e).bind("scroll",function(){var n,c=(e.pageYOffset,o[0].body.scrollHeight),i=o[0].body.scrollTop,s=$(a).outerHeight();s&&i>=s&&(n=t.getPage(),t.getPhotos({term:r.searchTerm,page:n}).then(function(e){r.photos=e},function(e){r.error=e}),i=c),s&&c==i+e.innerHeight&&(t.getPhotos({term:r.searchTerm}).then(function(e){r.photos=e},function(e){r.error=e}),i=c),r.$apply()})}}]),angular.module("mySearch").service("flickrRepoService",["flickrService","$q",function(e,o){var t=[],r=1,a=0;return{getPage:function(){return r},clearPhotos:function(){t=[],r=1},getPhotos:function(n){var c=n.term,i=o.defer();return n.page&&r==n.page&&0===a||!n.page?(a++,e.get({term:c,page:r}).then(function(e){t=t.concat(e),r+=1,i.resolve(t),a=0},function(e){i.reject(e.message),a=0})):i.reject(),i.promise}}}]),angular.module("mySearch").service("flickrService",["$http","$q","apiKey",function(e,o,t){return{get:function(r){var a={page:r.page,term:r.term},n="https://api.flickr.com/services/rest/",c={text:a.term,method:"flickr.photos.search",api_key:encodeURIComponent(t),format:"json",per_page:30,nojsoncallback:1,page:a.page},i=n+"?"+$.param(c),s=o.defer();return e.get(i).then(function(e){if("fail"===e.data.stat)return s.reject({message:"Problem with connection"});if(0===e.data.photos.pages)return s.reject({message:"Not found photos"});if(e.data.photos.page>e.data.photos.pages)return s.reject({message:"Not more photos"});for(var o=e.data.photos.photo,t=o.length,r=[],a=0;t>a;a++){var n=o[a],c="https://farm"+n.farm+".staticflickr.com/"+n.server+"/"+n.id+"_"+n.secret+"_q.jpg",i={url:c,title:n.title};r.push(i)}s.resolve(r)},function(e){s.reject({message:"Problem with connection"})}),s.promise}}}]);